services:
  app:
    build: .
    ports:
      - '8081:8081'
    environment:
      - SPRING_DATA_REDIS_HOST=redis
      - SPRING_DATA_REDIS_PORT=6379
      - SPRING_DATA_REDIS_PASSWORD=admin
      - SPRING_DATA_MONGODB_URI=mongodb://mongo:27017/deployzilla
      - SPRING_MONGODB_URI=mongodb://mongo:27017/deployzilla
      - DOCKER_HOST=tcp://docker-proxy:2375
      # Use absolute host paths for volumes that spawned containers need to access
      - DEPLOYZILLA_WORKSPACE_PATH=${PWD}/deployzilla-workspaces
      - DEPLOYZILLA_WORKSPACE_LOCAL_PATH=/workspaces
      - DEPLOYZILLA_KEYS_PATH=${PWD}/deployzilla-keys
      - DEPLOYZILLA_REMOTE_PORT=2233
      - DEPLOYZILLA_REMOTE_USER=deployzilla
      - DEPLOYZILLA_REMOTE_PASSWORD=4kWM66FHnYvbiGzYBxsb
      - DOCKER_REGISTRY_USER=piryth
      - DOCKER_REGISTRY_PASSWORD=C8&(Z6%e*8Uw!t:B
    volumes:
      # Bind mount host directories (spawned containers can access these)
      - ./deployzilla-workspaces:/workspaces
      - ./deployzilla-keys:/secure-keys
    depends_on:
      - redis
      - mongo
      - docker-proxy
    networks:
      - deployzilla
      - default

  docker-proxy:
    image: tecnativa/docker-socket-proxy
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      # Allow container operations
      CONTAINERS: 1
      IMAGES: 1
      NETWORKS: 1
      VOLUMES: 1
      POST: 1
      GET: 1
      BUILD: 1
      # Deny dangerous operations
      AUTH: 0
      SECRETS: 0
      SWARM: 0
      COMMIT: 0
      #CONFIGS: 0
      #DISTRIBUTION: 0
      #EXEC: 0
      #GRPC: 0
      #NODES: 0
      #PLUGINS: 0
      #SERVICES: 0
      #SESSION: 0
      #SYSTEM: 0
      #TASKS: 0
    networks:
      - deployzilla

  redis:
    image: redis:alpine
    command: redis-server --requirepass admin
    ports:
      - '6379:6379'

  redis-insight:
    image: redis/redisinsight:latest
    ports:
      - '5540:5540'
    depends_on:
      - redis

  mongo:
    image: mongo:latest
    ports:
      - '27017:27017'
    volumes:
      - mongo-data:/data/db

  sonarqube:
    image: sonarqube:lts-community
    container_name: sonarqube
    ports:
      - '9000:9000'
    networks:
      - deployzilla
      - sonarnet
    environment:
      - SONAR_JDBC_URL=jdbc:postgresql://sonar_db:5432/sonar
      - SONAR_JDBC_USERNAME=sonar
      - SONAR_JDBC_PASSWORD=sonar
    volumes:
      - sonar_data:/opt/sonarqube/data
      - sonar_extensions:/opt/sonarqube/extensions
      - sonar_logs:/opt/sonarqube/logs
    depends_on:
      - sonar_db

  sonar_db:
    image: postgres:15
    container_name: sonar_db
    networks:
      - sonarnet
    environment:
      - POSTGRES_USER=sonar
      - POSTGRES_PASSWORD=sonar
      - POSTGRES_DB=sonar
    volumes:
      - sonar_db_data:/var/lib/postgresql/data

  # Builder services to create the images used by the application
  step-git-clone:
    image: deployzilla/step:git-clone
    build:
      context: ./src/main/resources/docker
      target: git-clone
    entrypoint: ["true"]
    networks:
      - deployzilla

  step-npm-lint:
    image: deployzilla/step:npm-lint
    build:
      context: ./src/main/resources/docker
      target: npm-lint
    entrypoint: ["true"]
    networks:
      - deployzilla

  step-npm-test:
    image: deployzilla/step:npm-test
    build:
      context: ./src/main/resources/docker
      target: npm-test
    entrypoint: ["true"]
    networks:
      - deployzilla

  step-npm-install:
    image: deployzilla/step:npm-install
    build:
      context: ./src/main/resources/docker
      target: npm-install
    entrypoint: ["true"]
    networks:
      - deployzilla
  
  step-npm-build:
    image: deployzilla/step:npm-build
    build:
      context: ./src/main/resources/docker
      target: npm-build
    entrypoint: ["true"]
    networks:
      - deployzilla
      - sonarnet

  # step-sonarqube-analysis:
  #   image: deployzilla/step:sonarqube
  #   build:
  #     context: ./src/main/resources/docker
  #     target: sonarqube
  #   entrypoint: [ "true" ]
  #   networks:
  #     - deployzilla

networks:
  sonarnet:
  deployzilla:
    name: deployzilla

volumes:
  mongo-data:
  sonar_data:
  sonar_extensions:
  sonar_logs:
  sonar_db_data:
  pipeline-workspaces:
